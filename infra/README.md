# Infrastructure Setup Guide

This directory contains all infrastructure automation for the microservices TODO application.

## Prerequisites

1. AWS CLI configured with appropriate credentials
2. Terraform >= 1.5.0
3. Ansible >= 2.9
4. SSH key pair for server access
5. Domain name configured (use freedns.afraid.org for free subdomain)

## Quick Start

1. **Configure Terraform variables:**
   ```bash
   cd infra/terraform
   cp terraform.tfvars.example terraform.tfvars
   # Edit terraform.tfvars with your values
   ```

2. **Deploy infrastructure:**
   ```bash
   terraform init
   terraform apply -auto-approve
   ```

This single command will:
- Provision AWS EC2 instance
- Configure security groups
- Generate Ansible inventory
- Run Ansible playbooks
- Deploy the application
- Configure Traefik with SSL

## Directory Structure

```
infra/
├── terraform/          # Infrastructure as Code
│   ├── main.tf         # Main Terraform configuration
│   ├── variables.tf    # Variable definitions
│   ├── outputs.tf      # Output values
│   └── user_data.sh    # EC2 initialization script
├── ansible/            # Configuration Management
│   ├── site.yml        # Main playbook
│   ├── inventory.ini   # Generated by Terraform
│   └── roles/          # Ansible roles
│       ├── dependencies/  # Install Docker, etc.
│       └── deploy/        # Deploy application
└── ci-cd/              # CI/CD pipelines
```

## Features

### Drift Detection
- Automatic drift detection on infrastructure changes
- Email notifications when drift is detected
- Manual approval required before applying changes
- Automatic deployment when no drift exists

### Idempotent Operations
- Re-running terraform apply does nothing unless changes exist
- Ansible only restarts services when files change
- No resource recreation unless drift occurs

### SSL & Domain Configuration
- Automatic HTTPS certificates via Let's Encrypt
- HTTP to HTTPS redirection
- Traefik reverse proxy configuration

## Environment Variables

Required in terraform.tfvars:
- `aws_region`: AWS region for deployment
- `instance_type`: EC2 instance type
- `public_key`: SSH public key for server access
- `domain`: Your domain name
- `acme_email`: Email for Let's Encrypt certificates

## CI/CD Setup

1. **GitHub Secrets Required:**
   - `AWS_ACCESS_KEY_ID`
   - `AWS_SECRET_ACCESS_KEY`
   - `EMAIL_USERNAME` (for drift notifications)
   - `EMAIL_PASSWORD`
   - `NOTIFICATION_EMAIL`

2. **Workflows:**
   - Infrastructure changes trigger terraform workflow
   - Application changes trigger deployment workflow
   - Manual approval required for infrastructure drift

## Troubleshooting

1. **Terraform state issues:**
   ```bash
   terraform refresh
   terraform plan
   ```

2. **Ansible connection issues:**
   ```bash
   ansible all -i inventory.ini -m ping
   ```

3. **Application not accessible:**
   - Check security groups allow ports 80/443
   - Verify domain DNS points to server IP
   - Check Docker containers are running: `docker-compose ps`